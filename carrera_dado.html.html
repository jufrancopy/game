<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Carreras de Autos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: linear-gradient(to bottom, #87CEEB, #3498db);
            min-height: 100vh;
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 95%;
        }
        .track {
            display: grid;
            grid-template-columns: repeat(10, 50px);
            grid-template-rows: repeat(10, 50px);
            gap: 2px;
            background: #333;
            padding: 10px;
            border-radius: 10px;
            position: relative;
            width: 520px;
            height: 520px;
        }
        .cell {
            width: 50px;
            height: 50px;
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
            font-size: 24px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .cell:hover {
            transform: scale(1.05);
        }
        .cell .number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            background-color: #333;
            color: white;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .cell.start {
            background: #4caf50;
            color: white;
        }
        .cell.mud { background: #a67c52; color: white; }
        .cell.water { background: #add8e6; color: #2c3e50; }
        .cell.oil { background: #2c3e50; color: white; }
        .cell.fire { background: #ff6347; color: white; }
        .cell.police { background: #3498db; color: white; }
        .cell.animal_bad { background: #ffd700; color: #2c3e50; }
        .cell.animal_good { background: #98fb98; color: #2c3e50; }
        .cell.ramp { background: #9b59b6; color: white; }
        .cell.turbo { background: #e74c3c; color: white; }
        .cell.detour { background: #bdc3c7; color: #2c3e50; }
        .cell.animal_rescue { background: #f1c40f; color: #2c3e50; }
        .cell.tire-change { background: #616161; color: white; }
        .cell.history-quiz { background: #3f51b5; color: white; }
        .cell.music-quiz { background: #9c27b0; color: white; }
        .car {
            position: absolute;
            font-size: 20px;
            transition: all 0.5s ease;
            z-index: 1;
            transform-origin: center;
        }
        .car1 { bottom: 15px; left: 10px; }
        .car2 { bottom: 15px; left: 20px; }
        .dice-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2;
            perspective: 1000px;
        }
        .dice {
            width: 100px;
            height: 100px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s ease;
            cursor: pointer;
        }
        .dice-face {
            position: absolute;
            width: 100px;
            height: 100px;
            background: #fff;
            border: 2px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .dice-face span {
            font-size: 40px;
            color: #333;
        }
        .face-1 { transform: translateZ(50px); }
        .face-2 { transform: rotateX(90deg) translateZ(50px); }
        .face-3 { transform: rotateY(90deg) translateZ(50px); }
        .face-4 { transform: rotateY(-90deg) translateZ(50px); }
        .face-5 { transform: rotateX(-90deg) translateZ(50px); }
        .face-6 { transform: rotateY(180deg) translateZ(50px); }
        .dice-result-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            width: 100px;
            height: 100px;
            background: #3498db;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            font-weight: bold;
            border: 3px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3;
            animation: spinAndFade 1.5s ease forwards;
        }
        @keyframes spinAndFade {
            0% { transform: translate(-50%, -50%) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            80% { transform: translate(-50%, -50%) rotate(360deg); opacity: 1; }
            100% { opacity: 0; }
        }
        .scoreboard {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 15px;
            background: #fff;
            color: #333;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .track-selector {
            margin-bottom: 20px;
            font-size: 16px;
        }
        .track-selector select {
            padding: 5px;
            font-size: 16px;
            border-radius: 5px;
        }
        .track-night .track {
            background: #1a1a1a;
        }
        .track-night .cell {
            background: #444;
            border-color: #666;
        }
        .track-night .cell.start {
            background: #2e7d32;
        }
        .track-wet .track {
            background: #0288d1;
        }
        .track-wet .cell {
            background: #4fc3f7;
            border-color: #0288d1;
        }
        .track-wet .cell.start {
            background: #4caf50;
        }
        .track-rally .track {
            background: #8d6e63;
        }
        .track-rally .cell {
            background: #d7ccc8;
            border-color: #6d4c41;
        }
        .track-rally .cell.start {
            background: #4caf50;
        }
        @media (max-width: 600px) {
            .track {
                grid-template-columns: repeat(10, 40px);
                grid-template-rows: repeat(10, 40px);
                width: 416px;
                height: 416px;
            }
            .cell {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            .cell .number {
                font-size: 8px;
                width: 12px;
                height: 12px;
            }
            .car {
                font-size: 16px;
            }
            .car1 { bottom: 10px; left: 8px; }
            .car2 { bottom: 10px; left: 15px; }
            .dice {
                width: 80px;
                height: 80px;
            }
            .dice-face {
                width: 80px;
                height: 80px;
            }
            .face-1 { transform: translateZ(40px); }
            .face-2 { transform: rotateX(90deg) translateZ(40px); }
            .face-3 { transform: rotateY(90deg) translateZ(40px); }
            .face-4 { transform: rotateY(-90deg) translateZ(40px); }
            .face-5 { transform: rotateX(-90deg) translateZ(40px); }
            .face-6 { transform: rotateY(180deg) translateZ(40px); }
            .dice-face span {
                font-size: 32px;
            }
            .dice-result-alert {
                width: 80px;
                height: 80px;
                font-size: 36px;
            }
            .scoreboard, .track-selector {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="track-selector">
            <label for="trackType">Selecciona la pista: </label>
            <select id="trackType">
                <option value="default">Clásica</option>
                <option value="night">Nocturna</option>
                <option value="wet">Mojada</option>
                <option value="rally">Rally con Arena</option>
            </select>
        </div>
        <div class="scoreboard">
            <div><span id="player1Name">Jugador 1</span>: <span id="score1">0</span> pts</div>
            <div>Turno: <span id="turn">Jugador 1</span></div>
            <div><span id="player2Name">Jugador 2</span>: <span id="score2">0</span> pts</div>
        </div>
        <div class="track" id="track">
            <div class="dice-container">
                <div class="dice" id="dice">
                    <div class="dice-face face-1"><span>⚀</span></div>
                    <div class="dice-face face-2"><span>⚁</span></div>
                    <div class="dice-face face-3"><span>⚂</span></div>
                    <div class="dice-face face-4"><span>⚃</span></div>
                    <div class="dice-face face-5"><span>⚄</span></div>
                    <div class="dice-face face-6"><span>⚅</span></div>
                </div>
                <div class="dice-result-alert" id="diceResultAlert"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script>
        // Configuración inicial
        const track = document.getElementById('track');
        const dice = document.getElementById('dice');
        const diceResultAlert = document.getElementById('diceResultAlert');
        const score1 = document.getElementById('score1');
        const score2 = document.getElementById('score2');
        const turnDisplay = document.getElementById('turn');
        const trackType = document.getElementById('trackType');
        const player1NameDisplay = document.getElementById('player1Name');
        const player2NameDisplay = document.getElementById('player2Name');
        const cells = [];
        const totalCells = 36; // Perímetro de la pista
        let currentPlayer = 1;
        let positions = [0, 0]; // Posiciones de los autos
        let scores = [parseInt(localStorage.getItem('player1Score')) || 0, parseInt(localStorage.getItem('player2Score')) || 0];
        let playerNames = ['Jugador 1', 'Jugador 2'];
        let playerColors = ['#ff0000', '#0000ff'];
        let skipTurns = [0, 0]; // Turnos perdidos
        let gameEnded = false;

        // Sonidos
        const moveSound = new Audio('https://www.soundjay.com/buttons/sounds/button-09.mp3');
        const winSound = new Audio('https://www.soundjay.com/misc/sounds/crowd-cheer-01.mp3');
        const penaltySound = new Audio('https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3');
        const diceSound = new Audio('https://www.soundjay.com/misc/sounds/dice-roll-01.mp3');
        const coinSound = new Audio('https://www.soundjay.com/misc/sounds/coins-01.mp3');
        const advanceSound = new Audio('https://www.soundjay.com/misc/sounds/coin-drop-1.mp3');
        const reverseSound = new Audio('https://www.soundjay.com/misc/sounds/error-4.mp3');

        // Preguntas sobre la historia de Paraguay
        const paraguayQuestions = [
            {
                question: '¿En qué año Paraguay obtuvo su independencia?',
                options: ['1811', '1808', '1821', '1816'],
                correct: '1811'
            },
            {
                question: '¿Quién fue el primer presidente de Paraguay?',
                options: ['José Gaspar Rodríguez de Francia', 'Carlos Antonio López', 'Francisco Solano López', 'Juan Gualberto González'],
                correct: 'José Gaspar Rodríguez de Francia'
            },
            {
                question: '¿Qué guerra enfrentó Paraguay entre 1864 y 1870?',
                options: ['Guerra del Chaco', 'Guerra de la Triple Alianza', 'Guerra del Pacífico', 'Guerra Guaraní'],
                correct: 'Guerra de la Triple Alianza'
            },
            {
                question: '¿Cuál es la capital de Paraguay?',
                options: ['Asunción', 'Encarnación', 'Ciudad del Este', 'Luque'],
                correct: 'Asunción'
            },
            {
                question: '¿Qué idioma indígena es cooficial en Paraguay junto con el español?',
                options: ['Quechua', 'Aymara', 'Guaraní', 'Tupi'],
                correct: 'Guaraní'
            }
        ];

        // Preguntas sobre música
        const musicQuestions = [
            {
                question: '¿Qué género musical es conocido como "música folklórica paraguaya"?',
                options: ['Polca paraguaya', 'Samba', 'Tango', 'Cumbia'],
                correct: 'Polca paraguaya'
            },
            {
                question: '¿Qué instrumento es icónico en la música tradicional paraguaya?',
                options: ['Arpa paraguaya', 'Bandoneón', 'Charango', 'Cajón'],
                correct: 'Arpa paraguaya'
            },
            {
                question: '¿Quién compuso la famosa canción paraguaya "Pájaro Campana"?',
                options: ['Félix Pérez Cardozo', 'José Asunción Flores', 'Agustín Barrios', 'Luis Alberto del Paraná'],
                correct: 'Félix Pérez Cardozo'
            },
            {
                question: '¿Qué estilo musical creó José Asunción Flores?',
                options: ['Guarania', 'Chamamé', 'Ranchera', 'Vallenato'],
                correct: 'Guarania'
            },
            {
                question: '¿Qué grupo paraguayo es famoso por interpretar canciones como "Recuerdos de Ypacaraí"?',
                options: ['Los Paraguayos', 'Los Kjarkas', 'Inti-Illimani', 'Los Calchakis'],
                correct: 'Los Paraguayos'
            }
        ];

        // Solicitar nombres y colores, mostrar récord
        async function getPlayerDetails() {
            const record = JSON.parse(localStorage.getItem('raceRecord'));
            const recordText = record ? `Récord actual: ${record.name} (${record.score} puntos, ${record.date})` : 'No hay récords aún.';
            const { value } = await Swal.fire({
                title: 'Ingresa los detalles de los jugadores',
                html: `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px; max-width: 400px; margin: auto;">
                        <div style="background: #f0f0f0; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 100%; text-align: center;">
                            <p style="margin: 0; font-weight: bold; color: #333;">${recordText}</p>
                        </div>
                        <div style="width: 100%;">
                            <label for="player1" style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Nombre Jugador 1:</label>
                            <input id="player1" class="swal2-input custom-input" placeholder="Jugador 1" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); transition: border-color 0.3s;">
                        </div>
                        <div style="width: 100%;">
                            <label for="color1" style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Color Jugador 1:</label>
                            <input type="color" id="color1" value="#ff0000" style="width: 60px; height: 40px; padding: 0; border: none; border-radius: 5px; cursor: pointer; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        </div>
                        <div style="width: 100%;">
                            <label for="player2" style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Nombre Jugador 2:</label>
                            <input id="player2" class="swal2-input custom-input" placeholder="Jugador 2" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); transition: border-color 0.3s;">
                        </div>
                        <div style="width: 100%;">
                            <label for="color2" style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Color Jugador 2:</label>
                            <input type="color" id="color2" value="#0000ff" style="width: 60px; height: 40px; padding: 0; border: none; border-radius: 5px; cursor: pointer; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        </div>
                    </div>
                `,
                focusConfirm: false,
                customClass: {
                    popup: 'custom-swal-popup'
                },
                didOpen: () => {
                    const style = document.createElement('style');
                    style.innerHTML = `
                        .custom-swal-popup {
                            border-radius: 15px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                            background: linear-gradient(to bottom, #ffffff, #f0f0f0);
                        }
                        .custom-input:focus {
                            border-color: #3498db !important;
                            outline: none;
                            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5) !important;
                        }
                        input[type="color"]:focus {
                            outline: 2px solid #3498db;
                        }
                    `;
                    document.head.appendChild(style);
                },
                preConfirm: () => {
                    return {
                        names: [
                            document.getElementById('player1').value || 'Jugador 1',
                            document.getElementById('player2').value || 'Jugador 2'
                        ],
                        colors: [
                            document.getElementById('color1').value,
                            document.getElementById('color2').value
                        ]
                    };
                }
            });
            if (value) {
                playerNames = value.names;
                playerColors = value.colors;
                player1NameDisplay.textContent = playerNames[0];
                player2NameDisplay.textContent = playerNames[1];
                turnDisplay.textContent = playerNames[0];
            }
        }

        // Cambiar tipo de pista
        trackType.addEventListener('change', () => {
            track.classList.remove('track-night', 'track-wet', 'track-rally');
            if (trackType.value !== 'default') {
                track.classList.add(`track-${trackType.value}`);
            }
        });

        // Crear la pista con casillas aleatorias
        function createTrack() {
            const path = [
                0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
                19, 29, 39, 49, 59, 69, 79, 89,
                98, 97, 96, 95, 94, 93, 92, 91, 90,
                80, 70, 60, 50, 40, 30, 20, 10
            ];
            const trapsTemplate = [
                { type: 'mud', icon: '💩' },
                { type: 'water', icon: '💧' },
                { type: 'history-quiz', icon: '📘' },
                { type: 'oil', icon: '🛢️' },
                { type: 'music-quiz', icon: '🎵' },
                { type: 'fire', icon: '🔥' },
                { type: 'police', icon: '👮' },
                { type: 'animal_bad', icon: '🐒' },
                { type: 'animal_good', icon: '🐰' },
                { type: 'ramp', icon: '🔼' },
                { type: 'tire-change', icon: '🚗' },
                { type: 'turbo', icon: '⚡' },
                { type: 'detour', icon: '↩️' },
                { type: 'animal_rescue', icon: '🐶' }
            ];

            // Aleatorizar índices (1 a 35)
            const availableIndices = Array.from({ length: 35 }, (_, i) => i + 1);
            for (let i = availableIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableIndices[i], availableIndices[j]] = [availableIndices[j], availableIndices[i]];
            }
            const traps = trapsTemplate.map((trap, i) => ({
                ...trap,
                index: availableIndices[i]
            }));

            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                if (path.includes(i)) {
                    const pathIndex = path.indexOf(i);
                    cell.dataset.index = pathIndex;
                    cell.innerHTML = `<span class="number">${pathIndex}</span>`;
                    if (pathIndex === 0) {
                        cell.classList.add('start');
                        cell.innerHTML += '🏁';
                    }
                    traps.forEach(trap => {
                        if (pathIndex === trap.index) {
                            cell.classList.add(trap.type);
                            cell.innerHTML = `<span class="number">${pathIndex}</span>${trap.icon}`;
                        }
                    });
                } else {
                    cell.style.background = '#999';
                }
                track.appendChild(cell);
                cells.push(cell);
            }

            // Colocar autos
            const car1 = document.createElement('div');
            car1.classList.add('car', 'car1');
            car1.innerHTML = '<i class="fa-solid fa-car-side"></i>';
            car1.style.color = playerColors[0];
            cells[path[0]].appendChild(car1);

            const car2 = document.createElement('div');
            car2.classList.add('car', 'car2');
            car2.innerHTML = '<i class="fa-solid fa-car-side"></i>';
            car2.style.color = playerColors[1];
            cells[path[0]].appendChild(car2);
        }

        // Obtener rotación según posición
        function getRotation(pos) {
            if (pos >= 0 && pos <= 9) return 0; // Arriba (derecha)
            if (pos >= 10 && pos <= 17) return 90; // Derecha (abajo)
            if (pos >= 18 && pos <= 26) return 180; // Abajo (izquierda)
            return 270; // Izquierda (arriba)
        }

        // Lanzar dado
        function rollDice() {
            if (gameEnded) return;
            if (skipTurns[currentPlayer - 1] > 0) {
                skipTurns[currentPlayer - 1]--;
                Toastify({
                    text: `${playerNames[currentPlayer - 1]} pierde este turno. Quedan ${skipTurns[currentPlayer - 1]} turnos perdidos.`,
                    duration: 2000,
                    style: { background: '#ff9800' }
                }).showToast();
                switchPlayer();
                return;
            }

            diceSound.play();
            const roll = Math.floor(Math.random() * 6) + 1;
            const rotations = {
                1: 'rotateX(0deg) rotateY(0deg)',
                2: 'rotateX(-90deg) rotateY(0deg)',
                3: 'rotateX(0deg) rotateY(90deg)',
                4: 'rotateX(0deg) rotateY(-90deg)',
                5: 'rotateX(90deg) rotateY(0deg)',
                6: 'rotateX(0deg) rotateY(180deg)'
            };
            dice.style.transform = rotations[roll];
            setTimeout(() => {
                coinSound.play();
                diceResultAlert.textContent = roll;
                diceResultAlert.style.display = 'flex';
                setTimeout(() => {
                    diceResultAlert.style.display = 'none';
                    moveCar(currentPlayer, roll);
                }, 1500);
            }, 1000);
        }

        // Mover auto (avance)
        function moveCar(player, steps) {
            let currentPos = positions[player - 1];
            let targetPos = (currentPos + steps) % totalCells;

            function moveStep() {
                currentPos = (currentPos + 1) % totalCells;
                positions[player - 1] = currentPos;
                advanceSound.play();

                const cell = cells.find(c => c.dataset.index == currentPos);
                const car = document.querySelector(`.car${player}`);
                const rotation = getRotation(currentPos);
                car.style.transform = `translate(${cell.offsetLeft}px, ${cell.offsetTop}px) rotate(${rotation}deg)`;

                if (currentPos !== targetPos) {
                    setTimeout(moveStep, 1000);
                } else {
                    setTimeout(() => checkCell(player, currentPos, cell), 600);
                }
            }

            moveStep();
        }

        // Mover auto a posición específica (retroceso)
        function moveCarToPosition(player, pos) {
            const cell = cells.find(c => c.dataset.index == pos);
            const car = document.querySelector(`.car${player}`);
            positions[player - 1] = pos;
            reverseSound.play();
            const rotation = getRotation(pos);
            car.style.transform = `translate(${cell.offsetLeft}px, ${cell.offsetTop}px) rotate(${rotation}deg)`;
        }

        // Verificar casilla
        async function checkCell(player, pos, cell) {
            let message = '';
            let bgColor = '#2196f3';
            let points = 0;

            if (cell.classList.contains('mud')) {
                skipTurns[player - 1] = 1;
                message = '¡Charco de lodo! Pierdes un turno.';
                bgColor = '#ff9800';
                penaltySound.play();
            } else if (cell.classList.contains('water')) {
                positions[player - 1] = Math.max(0, positions[player - 1] - 2);
                message = '¡Charco de agua! Retrocedes 2 casillas.';
                bgColor = '#ff9800';
                penaltySound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('oil')) {
                positions[player - 1] = Math.max(0, positions[player - 1] - 3);
                message = '¡Charco de aceite! Retrocedes 3 casillas.';
                bgColor = '#ff9800';
                penaltySound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('fire')) {
                skipTurns[player - 1] = 2;
                message = '¡Incendio! Pierdes 2 turnos.';
                bgColor = '#f44336';
                penaltySound.play();
            } else if (cell.classList.contains('police')) {
                skipTurns[player - 1] = 2;
                message = '¡Infracción! Pierdes 2 turnos.';
                bgColor = '#f44336';
                penaltySound.play();
            } else if (cell.classList.contains('animal_bad')) {
                positions[player - 1] = Math.max(0, positions[player - 1] - 5);
                message = '¡Mono travieso! Retrocedes 5 casillas.';
                bgColor = '#ff9800';
                penaltySound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('animal_good')) {
                positions[player - 1] = (positions[player - 1] + 5) % totalCells;
                points += 50;
                message = '¡Conejo veloz! Avanzas 5 casillas y ganas 50 puntos.';
                bgColor = '#4caf50';
                moveSound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('ramp')) {
                positions[player - 1] = (positions[player - 1] + 7) % totalCells;
                points += 30;
                message = '¡Rampa! Saltas 7 casillas y ganas 30 puntos.';
                bgColor = '#4caf50';
                moveSound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('turbo')) {
                positions[player - 1] = (positions[player - 1] + 10) % totalCells;
                points += 50;
                message = '¡Turbo! Avanzas 10 casillas y ganas 50 puntos.';
                bgColor = '#4caf50';
                moveSound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('detour')) {
                positions[player - 1] = Math.max(0, positions[player - 1] - 5);
                message = '¡Desvío! Retrocedes 5 casillas.';
                bgColor = '#ff9800';
                penaltySound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('animal_rescue')) {
                positions[player - 1] = (positions[player - 1] + 8) % totalCells;
                points += 40;
                message = '¡Perro rescatador! Avanzas 8 casillas y ganas 40 puntos.';
                bgColor = '#4caf50';
                moveSound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('tire-change')) {
                positions[player - 1] = Math.max(0, positions[player - 1] - 3);
                message = '¡Recambio de cubiertas! Retrocedes 3 casillas.';
                bgColor = '#ff9800';
                penaltySound.play();
                moveCarToPosition(player, positions[player - 1]);
            } else if (cell.classList.contains('history-quiz')) {
                const quiz = paraguayQuestions[Math.floor(Math.random() * paraguayQuestions.length)];
                const { value: answer } = await Swal.fire({
                    title: 'Pregunta sobre la historia de Paraguay',
                    text: quiz.question,
                    input: 'radio',
                    inputOptions: quiz.options.reduce((obj, opt) => ({ ...obj, [opt]: opt }), {}),
                    inputValidator: (value) => !value && '¡Debes seleccionar una opción!'
                });

                if (answer) {
                    if (answer === quiz.correct) {
                        positions[player - 1] = (positions[player - 1] + 5) % totalCells;
                        points += 50;
                        message = '¡Respuesta correcta! Avanzas 5 casillas y ganas 50 puntos.';
                        bgColor = '#4caf50';
                        moveSound.play();
                        moveCarToPosition(player, positions[player - 1]);
                    } else {
                        positions[player - 1] = Math.max(0, positions[player - 1] - 3);
                        message = '¡Respuesta incorrecta! Retrocedes 3 casillas.';
                        bgColor = '#ff9800';
                        penaltySound.play();
                        moveCarToPosition(player, positions[player - 1]);
                    }
                } else {
                    message = '¡No respondiste! Pierdes el turno.';
                    bgColor = '#ff9800';
                    penaltySound.play();
                }
            } else if (cell.classList.contains('music-quiz')) {
                const quiz = musicQuestions[Math.floor(Math.random() * musicQuestions.length)];
                const { value: answer } = await Swal.fire({
                    title: 'Pregunta sobre música',
                    text: quiz.question,
                    input: 'radio',
                    inputOptions: quiz.options.reduce((obj, opt) => ({ ...obj, [opt]: opt }), {}),
                    inputValidator: (value) => !value && '¡Debes seleccionar una opción!'
                });

                if (answer) {
                    if (answer === quiz.correct) {
                        positions[player - 1] = (positions[player - 1] + 5) % totalCells;
                        points += 50;
                        message = '¡Respuesta correcta! Avanzas 5 casillas y ganas 50 puntos.';
                        bgColor = '#4caf50';
                        moveSound.play();
                        moveCarToPosition(player, positions[player - 1]);
                    } else {
                        positions[player - 1] = Math.max(0, positions[player - 1] - 3);
                        message = '¡Respuesta incorrecta! Retrocedes 3 casillas.';
                        bgColor = '#ff9800';
                        penaltySound.play();
                        moveCarToPosition(player, positions[player - 1]);
                    }
                } else {
                    message = '¡No respondiste! Pierdes el turno.';
                    bgColor = '#ff9800';
                    penaltySound.play();
                }
            } else {
                message = `${playerNames[player - 1]} avanzó ${diceResultAlert.textContent} casillas.`;
                bgColor = '#2196f3';
            }

            // Actualizar puntuación
            scores[player - 1] += points;
            score1.textContent = scores[0];
            score2.textContent = scores[1];

            // Guardar en LocalStorage
            localStorage.setItem('player1Score', scores[0]);
            localStorage.setItem('player2Score', scores[1]);

            // Verificar victoria
            if (positions[player - 1] === 0 && pos !== 0) {
                gameEnded = true;
                winSound.play();
                const jsConfetti = new JSConfetti();
                jsConfetti.addConfetti({
                    emojis: ['🌟', '🎉'],
                    confettiNumber: 100,
                    confettiRadius: 6,
                });
                setTimeout(() => jsConfetti.clearCanvas(), 2000);
                localStorage.setItem('raceRecord', JSON.stringify({
                    name: playerNames[player - 1],
                    score: scores[player - 1],
                    date: new Date().toLocaleString()
                }));
                Swal.fire({
                    title: `¡${playerNames[player - 1]} gana!`,
                    text: `Completaste una vuelta completa. Puntuación final: ${scores[player - 1]} puntos.`,
                    icon: 'success',
                    confirmButtonText: 'Reiniciar'
                }).then(() => {
                    localStorage.removeItem('player1Score');
                    localStorage.removeItem('player2Score');
                    window.location.reload();
                });
                return;
            }

            // Mostrar notificación
            Toastify({
                text: `${playerNames[player - 1]}: ${message}`,
                duration: 3000,
                style: { background: bgColor }
            }).showToast();

            switchPlayer();
        }

        // Cambiar turno
        function switchPlayer() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            turnDisplay.textContent = playerNames[currentPlayer - 1];
        }

        // Inicializar
        async function init() {
            await getPlayerDetails();
            createTrack();
            score1.textContent = scores[0];
            score2.textContent = scores[1];
            dice.addEventListener('click', rollDice);
        }

        init();
    </script>
</body>
</html>

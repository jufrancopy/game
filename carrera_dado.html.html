<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Carreras Paraguay</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-light: #f9f9f9;
            --text-color: #2c3e50;
            --shadow-normal: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-large: 0 8px 20px rgba(0, 0, 0, 0.2);
            --radius-small: 6px;
            --radius-normal: 8px;
            --track-cell-size-desktop: 50px;
            --track-cell-size-mobile: 32px;
            --font-size-small: 12px;
            --font-size-normal: 16px;
            --font-size-large: 20px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: linear-gradient(to bottom, #87CEEB, #2980b9);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            width: 100%;
        }

        .game-title {
            font-size: 24px;
            margin: 10px 0 5px;
            font-weight: bold;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-normal);
            padding: 15px;
            box-shadow: var(--shadow-large);
            max-width: 95%;
            width: 550px;
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
        }

        .track-selector {
            display: flex;
            align-items: center;
            font-size: var(--font-size-small);
        }

        .weather-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: var(--font-size-small);
        }

        .weather-icon {
            font-size: var(--font-size-normal);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .weather-icon:hover {
            transform: scale(1.2);
        }

        .weather-icon.active {
            color: var(--accent-color);
            text-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
        }

        .track-selector select {
            padding: 5px;
            font-size: var(--font-size-small);
            border-radius: var(--radius-small);
            background: white;
            border: 1px solid #ddd;
            transition: all 0.3s;
            margin-left: 5px;
        }

        .track-selector select:hover {
            background: #f0f0f0;
        }

        .scoreboard {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
            background: #fff;
            color: var(--text-color);
            border-radius: var(--radius-normal);
            margin-bottom: 10px;
            font-size: var(--font-size-small);
            box-shadow: var(--shadow-normal);
        }

        .player-score {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .car-icon {
            font-size: var(--font-size-small);
        }

        .turn-indicator {
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: var(--radius-small);
            font-weight: bold;
            box-shadow: var(--shadow-normal);
        }

        .track-container {
            position: relative;
            width: 100%;
            height: 520px;
            display: flex;
            justify-content: center;
        }

        .track {
            display: grid;
            grid-template-columns: repeat(10, var(--track-cell-size-desktop));
            grid-template-rows: repeat(10, var(--track-cell-size-desktop));
            gap: 2px;
            background: #333;
            padding: 8px;
            border-radius: var(--radius-normal);
            position: relative;
            width: 520px;
            height: 520px;
            transition: transform 0.3s ease;
        }

        .cell {
            width: var(--track-cell-size-desktop);
            height: var(--track-cell-size-desktop);
            background: var(--background-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
            font-size: 24px;
            border: 2px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .cell:hover {
            transform: scale(1.05);
        }

        .cell .number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            background-color: #333;
            color: white;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .cell.start {
            background: #4caf50;
            color: white;
        }

        .cell.mud {
            background: #a67c52;
            color: white;
        }

        .cell.water {
            background: #add8e6;
            color: #2c3e50;
        }

        .cell.oil {
            background: #2c3e50;
            color: white;
        }

        .cell.fire {
            background: #ff6347;
            color: white;
        }

        .cell.police {
            background: #3498db;
            color: white;
        }

        .cell.animal_bad {
            background: #ffd700;
            color: #2c3e50;
        }

        .cell.animal_good {
            background: #98fb98;
            color: #2c3e50;
        }

        .cell.ramp {
            background: #9b59b6;
            color: white;
        }

        .cell.turbo {
            background: #e74c3c;
            color: white;
        }

        .cell.detour {
            background: #bdc3c7;
            color: #2c3e50;
        }

        .cell.animal_rescue {
            background: #f1c40f;
            color: #2c3e50;
        }

        .cell.tire-change {
            background: #616161;
            color: white;
        }

        .cell.history-quiz {
            background: #3f51b5;
            color: white;
        }

        .cell.music-quiz {
            background: #9c27b0;
            color: white;
        }

        .cell.shop {
            background: #ff9800;
            color: white;
        }

        .cell.bonus {
            background: #00bcd4;
            color: white;
        }

        .cell.event {
            background: #673ab7;
            color: white;
        }

        .car {
            position: absolute;
            font-size: 18px;
            transition: all 0.5s ease;
            z-index: 10;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
        }

        .dice-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 20;
        }

        .dice {
            width: 80px;
            height: 80px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            border: 2px solid #333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .dice-face {
            font-size: 50px;
            display: inline-block;
            transition: transform 0.1s ease;
            /* Transici√≥n r√°pida para la rotaci√≥n */
        }

        .dice.rolling {
            animation: none;
            /* Desactivar pulso durante la rotaci√≥n */
            transition: transform 0.1s ease;
            /* Asegurar transici√≥n suave para la rotaci√≥n */
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
        }

        .dice:hover {
            transform: scale(1.1);
        }

        .game-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
        }

        .control-btn {
            padding: 8px 15px;
            border-radius: var(--radius-small);
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: var(--font-size-small);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-normal);
        }

        .control-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .boost-btn {
            background: var(--accent-color);
        }

        .boost-btn:hover {
            background: #c0392b;
        }

        .help-btn {
            background: #27ae60;
        }

        .help-btn:hover {
            background: #2ecc71;
        }

        .inventory-btn {
            background: #f39c12;
        }

        .inventory-btn:hover {
            background: #f1c40f;
        }

        .power-ups {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            justify-content: center;
        }

        .power-up {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            box-shadow: var(--shadow-normal);
            transition: all 0.3s;
            border: 2px solid #ddd;
        }

        .power-up:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .power-up.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .track-night .track {
            background: #1a1a1a;
        }

        .track-night .cell {
            background: #444;
            border-color: #666;
        }

        .track-night .cell.start {
            background: #2e7d32;
        }

        .track-wet .track {
            background: #0288d1;
        }

        .track-wet .cell {
            background: #4fc3f7;
            border-color: #0288d1;
        }

        .track-wet .cell.start {
            background: #4caf50;
        }

        .track-rally .track {
            background: #8d6e63;
        }

        .track-rally .cell {
            background: #d7ccc8;
            border-color: #6d4c41;
        }

        .track-rally .cell.start {
            background: #4caf50;
        }

        .track-snowy {
            background: linear-gradient(to bottom, #e0f7fa, #b3e5fc);
        }

        .track-snowy .track {
            background: #b3e5fc;
        }

        .track-snowy .cell {
            background: #e1f5fe;
            border-color: #81d4fa;
        }

        .weather-effects {
            position: absolute;
            pointer-events: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
            z-index: 5;
            border-radius: var(--radius-normal);
        }

        .rain {
            position: absolute;
            width: 2px;
            background: rgba(174, 194, 224, 0.5);
            border-radius: 5px;
        }

        .snow {
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 5px white;
        }

        .mini-map {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-small);
            box-shadow: var(--shadow-normal);
            overflow: hidden;
            z-index: 5;
            border: 1px solid #ddd;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 1px;
            padding: 2px;
        }

        .mini-cell {
            background: #eee;
            border-radius: 1px;
        }

        .mini-cell.path {
            background: #aaa;
        }

        .mini-cell.start {
            background: #4caf50;
        }

        .mini-car {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            z-index: 1;
            transition: all 0.5s ease;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .lap-counter {
            font-size: var(--font-size-small);
            margin-top: 5px;
            color: var(--text-color);
        }

        .hint-text {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            width: 100%;
            padding: 0 10px;
        }

        .status-effects {
            display: flex;
            gap: 5px;
            margin: 5px 0;
        }

        .status-effect {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 5px;
            border-radius: 12px;
            font-size: 10px;
            background: #f0f0f0;
        }

        .status-effect.positive {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .status-effect.negative {
            background: rgba(231, 76, 60, 0.2);
            color: #c0392b;
        }

        .boosted {
            animation: boosted 1s infinite alternate;
        }

        @keyframes boosted {
            0% {
                filter: drop-shadow(0 0 3px rgba(255, 0, 0, 0.5));
            }

            100% {
                filter: drop-shadow(0 0 8px rgba(255, 0, 0, 0.8));
            }
        }

        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .tutorial-content {
            background: white;
            padding: 20px;
            border-radius: var(--radius-normal);
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            text-align: center;
        }

        .tutorial-step {
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            :root {
                --track-cell-size-mobile: 32px;
            }

            body {
                padding: 5px;
            }

            .game-title {
                font-size: 18px;
                margin: 5px 0;
            }

            .game-container {
                padding: 10px;
                border-radius: 6px;
            }

            .track-container {
                height: 340px;
            }

            .track {
                grid-template-columns: repeat(10, var(--track-cell-size-mobile));
                grid-template-rows: repeat(10, var(--track-cell-size-mobile));
                width: 340px;
                height: 340px;
                padding: 5px;
            }

            .cell {
                width: var(--track-cell-size-mobile);
                height: var(--track-cell-size-mobile);
                font-size: 16px;
                border-radius: 4px;
            }

            .cell .number {
                font-size: 8px;
                width: 12px;
                height: 12px;
            }

            .car {
                font-size: 14px;
            }

            .scoreboard {
                font-size: 10px;
                padding: 5px;
                margin-bottom: 5px;
            }

            .track-selector,
            .weather-toggle {
                font-size: 10px;
            }

            .track-selector select {
                font-size: 10px;
                padding: 2px;
            }

            .control-btn {
                padding: 5px 10px;
                font-size: 10px;
            }

            .power-up {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }

            .mini-map {
                width: 80px;
                height: 80px;
                bottom: 5px;
                right: 5px;
            }

            .hint-text {
                font-size: 8px;
            }

            .status-effect {
                font-size: 8px;
                padding: 2px 4px;
            }

            .top-controls {
                flex-direction: column;
                gap: 5px;
                align-items: center;
            }

            .weather-toggle {
                order: -1;
                margin-bottom: 5px;
            }

            .dice {
                width: 60px;
                height: 60px;
                padding: 5px;
            }

            .dice-face {
                font-size: 40px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 class="game-title">Super Carreras Paraguay</h1>
    </div>

    <div class="game-container">
        <div class="top-controls">
            <div class="track-selector">
                <label for="trackType">Pista: </label>
                <select id="trackType">
                    <option value="default">Cl√°sica</option>
                    <option value="night">Nocturna</option>
                    <option value="wet">Mojada</option>
                    <option value="rally">Rally</option>
                    <option value="snowy">Nevada</option>
                </select>
            </div>
            <div class="weather-toggle">
                <span>Clima: </span>
                <span id="weatherNormal" class="weather-icon active" title="Normal">‚òÄÔ∏è</span>
                <span id="weatherRain" class="weather-icon" title="Lluvia">üåßÔ∏è</span>
                <span id="weatherSnow" class="weather-icon" title="Nieve">‚ùÑÔ∏è</span>
            </div>
        </div>

        <div class="scoreboard">
            <div class="player-score">
                <i class="car-icon fas fa-car-side" id="player1Color"></i>
                <span id="player1Name">Jugador 1</span>: <span id="score1">0</span> pts
                <div class="status-effects" id="status1"></div>
            </div>
            <div class="turn-indicator">
                Turno: <span id="turn">Jugador 1</span>
            </div>
            <div class="player-score">
                <i class="car-icon fas fa-car-side" id="player2Color"></i>
                <span id="player2Name">Jugador 2</span>: <span id="score2">0</span> pts
                <div class="status-effects" id="status2"></div>
            </div>
        </div>

        <div class="track-container">
            <div class="track" id="track">
                <div class="weather-effects" id="weatherEffects"></div>
                <div class="dice-container">
                    <div class="dice" id="dice"><span class="dice-face">üé≤</span></div>
                </div>
            </div>
            <div class="mini-map" id="miniMap"></div>
        </div>

        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        <div class="lap-counter">Vuelta: <span id="currentLap">1</span> / <span id="totalLaps">3</span></div>

        <div class="power-ups" id="powerUps">
            <div class="power-up" data-type="shield" title="Escudo">üõ°Ô∏è</div>
            <div class="power-up" data-type="boost" title="Nitro">üöÄ</div>
            <div class="power-up" data-type="repair" title="Reparar">üîß</div>
            <div class="power-up" data-type="trap" title="Trampa">üí£</div>
            <div class="power-up" data-type="teleport" title="Teletransporte">‚ö°</div>
        </div>

        <div class="game-controls">
            <button class="control-btn help-btn" id="helpBtn"><i class="fas fa-question-circle"></i> Ayuda</button>
            <button class="control-btn inventory-btn" id="inventoryBtn"><i class="fas fa-briefcase"></i>
                Inventario</button>
            <button class="control-btn boost-btn" id="boostBtn"><i class="fas fa-bolt"></i> Turbo</button>
        </div>
    </div>

    <div class="hint-text">Toca el dado para lanzar o sacude tu tel√©fono</div>

    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-content">
            <h2>Bienvenido a Super Carreras Paraguay</h2>
            <div class="tutorial-step">
                <p>1. Lanza el dado toc√°ndolo o sacudiendo tu tel√©fono para mover tu auto.</p>
            </div>
            <div class="tutorial-step">
                <p>2. Cae en casillas especiales para ganar puntos, avanzar, retroceder o responder preguntas.</p>
            </div>
            <div class="tutorial-step">
                <p>3. Usa power-ups como escudo, nitro o trampas desde el inventario.</p>
            </div>
            <div class="tutorial-step">
                <p>4. Completa 3 vueltas para ganar. ¬°Cuidado con el clima!</p>
            </div>
            <button class="control-btn" onclick="closeTutorial()">Comenzar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script>
        // Configuraci√≥n inicial
        const track = document.getElementById('track');
        const dice = document.getElementById('dice');
        const score1 = document.getElementById('score1');
        const score2 = document.getElementById('score2');
        const turnDisplay = document.getElementById('turn');
        const trackType = document.getElementById('trackType');
        const player1NameDisplay = document.getElementById('player1Name');
        const player2NameDisplay = document.getElementById('player2Name');
        const player1ColorIcon = document.getElementById('player1Color');
        const player2ColorIcon = document.getElementById('player2Color');
        const status1 = document.getElementById('status1');
        const status2 = document.getElementById('status2');
        const progress = document.getElementById('progress');
        const currentLapDisplay = document.getElementById('currentLap');
        const totalLapsDisplay = document.getElementById('totalLaps');
        const miniMap = document.getElementById('miniMap');
        const weatherEffects = document.getElementById('weatherEffects');
        const weatherNormal = document.getElementById('weatherNormal');
        const weatherRain = document.getElementById('weatherRain');
        const weatherSnow = document.getElementById('weatherSnow');
        const helpBtn = document.getElementById('helpBtn');
        const inventoryBtn = document.getElementById('inventoryBtn');
        const boostBtn = document.getElementById('boostBtn');
        const powerUpsContainer = document.getElementById('powerUps');
        const tutorialOverlay = document.getElementById('tutorialOverlay');

        const cells = [];
        const miniCells = [];
        const totalCells = 36;
        const path = [
            0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
            19, 29, 39, 49, 59, 69, 79, 89,
            98, 97, 96, 95, 94, 93, 92, 91, 90,
            80, 70, 60, 50, 40, 30, 20, 10
        ];
        let currentPlayer = 1;
        let positions = [0, 0];
        let totalSteps = [0, 0];
        let scores = [parseInt(localStorage.getItem('player1Score')) || 0, parseInt(localStorage.getItem('player2Score')) || 0];
        let playerNames = ['Jugador 1', 'Jugador 2'];
        let playerColors = ['#ff0000', '#0000ff'];
        let skipTurns = [0, 0];
        let boostActive = [false, false];
        let shieldActive = [false, false];
        let itemInventory = [[], []];
        let laps = [1, 1];
        let totalLaps = 3;
        let gameEnded = false;
        let isShaking = false;
        let lastSteps = 0;
        let currentWeather = 'normal';
        let raindrops = [];
        let snowflakes = [];
        let traps = [];
        let carCondition = [100, 100];
        let repairActive = [false, false];

        // Sonidos
        const moveSound = new Audio('https://www.soundjay.com/buttons/sounds/button-09.mp3');
        const winSound = new Audio('https://www.soundjay.com/misc/sounds/crowd-cheer-01.mp3');
        const penaltySound = new Audio('https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3');
        const diceSound = new Audio('https://www.soundjay.com/misc/sounds/dice-roll-01.mp3');
        const coinSound = new Audio('https://www.soundjay.com/misc/sounds/coins-01.mp3');
        const advanceSound = new Audio('https://www.soundjay.com/misc/sounds/coin-drop-1.mp3');
        const reverseSound = new Audio('https://www.soundjay.com/misc/sounds/error-4.mp3');
        const boostSound = new Audio('https://www.soundjay.com/mechanical/sounds/car-driving-02.mp3');
        const shieldSound = new Audio('https://www.soundjay.com/buttons/sounds/button-30.mp3');
        const repairSound = new Audio('https://www.soundjay.com/mechanical/sounds/car-ignition-1.mp3');
        const explosionSound = new Audio('https://www.soundjay.com/mechanical/sounds/robot-06.mp3');
        const rainSound = new Audio('https://www.soundjay.com/nature/sounds/rain-07.mp3');
        rainSound.loop = true;

        // Preguntas
        const paraguayQuestions = [
            { question: '¬øEn qu√© a√±o Paraguay obtuvo su independencia?', options: ['1811', '1808', '1821', '1816'], correct: '1811' },
            { question: '¬øQui√©n fue el primer presidente de Paraguay?', options: ['Jos√© Gaspar Rodr√≠guez de Francia', 'Carlos Antonio L√≥pez', 'Francisco Solano L√≥pez', 'Juan Gualberto Gonz√°lez'], correct: 'Jos√© Gaspar Rodr√≠guez de Francia' },
            { question: '¬øQu√© guerra enfrent√≥ Paraguay entre 1864 y 1870?', options: ['Guerra del Chaco', 'Guerra de la Triple Alianza', 'Guerra del Pac√≠fico', 'Guerra Guaran√≠'], correct: 'Guerra de la Triple Alianza' },
            { question: '¬øCu√°l es la capital de Paraguay?', options: ['Asunci√≥n', 'Encarnaci√≥n', 'Ciudad del Este', 'Luque'], correct: 'Asunci√≥n' },
            { question: '¬øQu√© idioma ind√≠gena es cooficial en Paraguay junto con el espa√±ol?', options: ['Quechua', 'Aymara', 'Guaran√≠', 'Tupi'], correct: 'Guaran√≠' }
        ];

        const musicQuestions = [
            { question: '¬øQu√© g√©nero musical es conocido como "m√∫sica folkl√≥rica paraguaya"?', options: ['Polca paraguaya', 'Samba', 'Tango', 'Cumbia'], correct: 'Polca paraguaya' },
            { question: '¬øQu√© instrumento es ic√≥nico en la m√∫sica tradicional paraguaya?', options: ['Arpa paraguaya', 'Bandone√≥n', 'Charango', 'Caj√≥n'], correct: 'Arpa paraguaya' },
            { question: '¬øQui√©n compuso la famosa canci√≥n paraguaya "P√°jaro Campana"?', options: ['F√©lix P√©rez Cardozo', 'Jos√© Asunci√≥n Flores', 'Agust√≠n Barrios', 'Luis Alberto del Paran√°'], correct: 'F√©lix P√©rez Cardozo' },
            { question: '¬øQu√© estilo musical cre√≥ Jos√© Asunci√≥n Flores?', options: ['Guarania', 'Chamam√©', 'Ranchera', 'Vallenato'], correct: 'Guarania' },
            { question: '¬øQu√© grupo paraguayo es famoso por interpretar canciones como "Recuerdos de Ypacara√≠"?', options: ['Los Paraguayos', 'Los Kjarkas', 'Inti-Illimani', 'Los Calchakis'], correct: 'Los Paraguayos' }
        ];

        // Tutorial
        function showTutorial() {
            tutorialOverlay.style.display = 'flex';
        }

        function closeTutorial() {
            tutorialOverlay.style.display = 'none';
        }

        // Solicitar nombres y colores
        async function getPlayerDetails() {
            const record = JSON.parse(localStorage.getItem('raceRecord'));
            const recordText = record ? `R√©cord: ${record.name} (${record.score} pts, ${record.date})` : 'No hay r√©cords.';
            const { value } = await Swal.fire({
                title: 'Ingresa los detalles de los jugadores',
                html: `
                    <div style="display: flex; flex-direction: column; gap: 4px; padding: 5px; max-width: 220px; margin: auto;">
                        <div style="background: #f0f0f0; padding: 3px 5px; border-radius: 3px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: 100%; text-align: center;">
                            <p style="margin: 0; font-size: 9px; font-weight: bold; color: #333;">${recordText}</p>
                        </div>
                        <label for="player1" style="font-size: 11px; font-weight: bold; color: #333; margin-bottom: 2px;">Nombre Jugador 1:</label>
                        <input id="player1" class="swal2-input" placeholder="Jugador 1" style="width: 100%; padding: 4px; font-size: 11px;">
                        <label for="color1" style="font-size: 11px; font-weight: bold; color: #333; margin-bottom: 2px;">Color Jugador 1:</label>
                        <input type="color" id="color1" value="#ff0000" style="width: 30px; height: 16px;">
                        <label for="player2" style="font-size: 11px; font-weight: bold; color: #333; margin-bottom: 2px;">Nombre Jugador 2:</label>
                        <input id="player2" class="swal2-input" placeholder="Jugador 2" style="width: 100%; padding: 4px; font-size: 11px;">
                        <label for="color2" style="font-size: 11px; font-weight: bold; color: #333; margin-bottom: 2px;">Color Jugador 2:</label>
                        <input type="color" id="color2" value="#0000ff" style="width: 30px; height: 16px;">
                    </div>
                `,
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        names: [
                            document.getElementById('player1').value || 'Jugador 1',
                            document.getElementById('player2').value || 'Jugador 2'
                        ],
                        colors: [
                            document.getElementById('color1').value,
                            document.getElementById('color2').value
                        ]
                    };
                }
            });
            if (value) {
                playerNames = value.names;
                playerColors = value.colors;
                player1NameDisplay.textContent = playerNames[0];
                player2NameDisplay.textContent = playerNames[1];
                player1ColorIcon.style.color = playerColors[0];
                player2ColorIcon.style.color = playerColors[1];
                turnDisplay.textContent = playerNames[0];
            }
        }

        // Cambiar tipo de pista
        trackType.addEventListener('change', () => {
            track.classList.remove('track-night', 'track-wet', 'track-rally', 'track-snowy');
            if (trackType.value !== 'default') {
                track.classList.add(`track-${trackType.value}`);
            }
        });

        // Efectos clim√°ticos
        function startRain() {
            rainSound.play();
            isRaining = true;
            currentWeather = 'rain';
            weatherNormal.classList.remove('active');
            weatherSnow.classList.remove('active');
            weatherRain.classList.add('active');
            for (let i = 0; i < 50; i++) {
                createRaindrop();
            }
            setInterval(() => {
                if (isRaining) createRaindrop();
            }, 100);
        }

        function stopRain() {
            rainSound.pause();
            isRaining = false;
            currentWeather = 'normal';
            raindrops.forEach(r => r.remove());
            raindrops = [];
        }

        function createRaindrop() {
            const raindrop = document.createElement('div');
            raindrop.classList.add('rain');
            raindrop.style.left = Math.random() * track.offsetWidth + 'px';
            raindrop.style.height = Math.random() * 20 + 10 + 'px';
            raindrop.style.top = '-50px';
            weatherEffects.appendChild(raindrop);
            raindrops.push(raindrop);
            animateRaindrop(raindrop);
        }

        function animateRaindrop(raindrop) {
            let y = -50;
            const speed = Math.random() * 5 + 5;
            const interval = setInterval(() => {
                y += speed;
                raindrop.style.top = y + 'px';
                if (y > track.offsetHeight) {
                    clearInterval(interval);
                    raindrop.remove();
                    raindrops = raindrops.filter(r => r !== raindrop);
                }
            }, 20);
        }

        function startSnow() {
            isSnowing = true;
            currentWeather = 'snow';
            weatherNormal.classList.remove('active');
            weatherRain.classList.remove('active');
            weatherSnow.classList.add('active');
            for (let i = 0; i < 30; i++) {
                createSnowflake();
            }
            setInterval(() => {
                if (isSnowing) createSnowflake();
            }, 200);
        }

        function stopSnow() {
            isSnowing = false;
            currentWeather = 'normal';
            snowflakes.forEach(s => s.remove());
            snowflakes = [];
        }

        function createSnowflake() {
            const snowflake = document.createElement('div');
            snowflake.classList.add('snow');
            snowflake.style.left = Math.random() * track.offsetWidth + 'px';
            snowflake.style.top = '-50px';
            weatherEffects.appendChild(snowflake);
            snowflakes.push(snowflake);
            animateSnowflake(snowflake);
        }

        function animateSnowflake(snowflake) {
            let y = -50;
            const speed = Math.random() * 2 + 2;
            const sway = Math.random() * 20 - 10;
            const interval = setInterval(() => {
                y += speed;
                snowflake.style.top = y + 'px';
                snowflake.style.left = parseFloat(snowflake.style.left) + Math.sin(y / 50) * sway + 'px';
                if (y > track.offsetHeight) {
                    clearInterval(interval);
                    snowflake.remove();
                    snowflakes = snowflakes.filter(s => s !== snowflake);
                }
            }, 20);
        }

        weatherNormal.addEventListener('click', () => {
            stopRain();
            stopSnow();
            weatherNormal.classList.add('active');
            weatherRain.classList.remove('active');
            weatherSnow.classList.remove('active');
            currentWeather = 'normal';
        });

        weatherRain.addEventListener('click', () => {
            stopSnow();
            startRain();
        });

        weatherSnow.addEventListener('click', () => {
            stopRain();
            startSnow();
        });

        // Crear la pista
        function createTrack() {
            const trapsTemplate = [
                { type: 'mud', icon: 'üí©' },
                { type: 'water', icon: 'üíß' },
                { type: 'history-quiz', icon: 'üìò' },
                { type: 'oil', icon: 'üõ¢Ô∏è' },
                { type: 'music-quiz', icon: 'üéµ' },
                { type: 'fire', icon: 'üî•' },
                { type: 'police', icon: 'üëÆ' },
                { type: 'animal_bad', icon: 'üêí' },
                { type: 'animal_good', icon: 'üê∞' },
                { type: 'ramp', icon: 'üîº' },
                { type: 'tire-change', icon: 'üöó' },
                { type: 'turbo', icon: '‚ö°' },
                { type: 'detour', icon: '‚Ü©Ô∏è' },
                { type: 'animal_rescue', icon: 'üê∂' },
                { type: 'shop', icon: 'üõí' },
                { type: 'bonus', icon: '‚≠ê' },
                { type: 'event', icon: 'üéâ' }
            ];

            const availableIndices = Array.from({ length: 35 }, (_, i) => i + 1);
            for (let i = availableIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableIndices[i], availableIndices[j]] = [availableIndices[j], availableIndices[i]];
            }
            traps = trapsTemplate.slice(0, Math.min(trapsTemplate.length, availableIndices.length)).map((trap, i) => ({
                ...trap,
                index: availableIndices[i]
            }));

            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                if (path.includes(i)) {
                    const pathIndex = path.indexOf(i);
                    cell.dataset.index = pathIndex;
                    cell.innerHTML = `<span class="number">${pathIndex}</span>`;
                    if (pathIndex === 0) {
                        cell.classList.add('start');
                        cell.innerHTML += 'üèÅ';
                    }
                    traps.forEach(trap => {
                        if (pathIndex === trap.index) {
                            cell.classList.add(trap.type);
                            cell.innerHTML = `<span class="number">${pathIndex}</span>${trap.icon}`;
                        }
                    });
                } else {
                    cell.style.background = '#999';
                }
                track.appendChild(cell);
                cells.push(cell);
            }

            // Crear minimapa
            for (let i = 0; i < 100; i++) {
                const miniCell = document.createElement('div');
                miniCell.classList.add('mini-cell');
                if (path.includes(i)) {
                    miniCell.classList.add('path');
                    if (i === path[0]) miniCell.classList.add('start');
                }
                miniMap.appendChild(miniCell);
                miniCells.push(miniCell);
            }

            // Colocar autos
            const car1 = document.createElement('div');
            car1.classList.add('car', 'car1');
            car1.innerHTML = '<i class="fa-solid fa-car-side"></i>';
            car1.style.color = playerColors[0];
            track.appendChild(car1);

            const car2 = document.createElement('div');
            car2.classList.add('car', 'car2');
            car2.innerHTML = '<i class="fa-solid fa-car-side"></i>';
            car2.style.color = playerColors[1];
            track.appendChild(car2);

            // Autos en minimapa
            const miniCar1 = document.createElement('div');
            miniCar1.classList.add('mini-car');
            miniCar1.style.backgroundColor = playerColors[0];
            miniMap.appendChild(miniCar1);

            const miniCar2 = document.createElement('div');
            miniCar2.classList.add('mini-car');
            miniCar2.style.backgroundColor = playerColors[1];
            miniMap.appendChild(miniCar2);

            // Posicionar autos inicialmente
            moveCarToPosition(1, 0, 0);
            moveCarToPosition(2, 0, 0);
        }

        // Obtener rotaci√≥n
        function getRotation(pos) {
            if (pos >= 0 && pos <= 9) return 0;
            if (pos >= 10 && pos <= 17) return 90;
            if (pos >= 18 && pos <= 26) return 180;
            return 270;
        }

        // Calcular coordenadas
        function getCellCoordinates(pos) {
            const cellSize = window.innerWidth <= 600 ? 32 : 50;
            const gap = window.innerWidth <= 600 ? 1 : 2;
            const padding = window.innerWidth <= 600 ? 5 : 8;
            const cellIndex = path[pos];
            const row = Math.floor(cellIndex / 10);
            const col = cellIndex % 10;
            const x = col * (cellSize + gap) + padding + (cellSize / 2);
            const y = row * (cellSize + gap) + padding + (cellSize / 2);
            return { x, y };
        }

        // Coordenadas para minimapa
        function getMiniMapCoordinates(pos) {
            const cellSize = window.innerWidth <= 600 ? 8 : 10;
            const gap = 1;
            const padding = 2;
            const cellIndex = path[pos];
            const row = Math.floor(cellIndex / 10);
            const col = cellIndex % 10;
            const x = col * (cellSize + gap) + padding + (cellSize / 2) - 4;
            const y = row * (cellSize + gap) + padding + (cellSize / 2) - 4;
            return { x, y };
        }

        // Lanzar dado
        function rollDice() {
            if (gameEnded || isShaking || skipTurns[currentPlayer - 1] > 0) {
                if (skipTurns[currentPlayer - 1] > 0) {
                    Toastify({
                        text: `${playerNames[currentPlayer - 1]} pierde el turno.`,
                        duration: 2000,
                        style: { background: '#ff9800', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                    }).showToast();
                    skipTurns[currentPlayer - 1]--;
                    switchPlayer();
                }
                return;
            }
            isShaking = true;
            diceSound.play();
            let roll = Math.floor(Math.random() * 6) + 1;
            if (currentWeather === 'rain') roll = Math.max(1, roll - 1);
            if (currentWeather === 'snow') roll = Math.max(1, roll - 2);
            if (boostActive[currentPlayer - 1]) roll += 2;

            const diceFace = document.querySelector('.dice-face');

            // Animaci√≥n de rotaci√≥n para el dado (emoji)
            let rotationCount = 0;
            const maxRotations = 3; // N√∫mero de giros completos
            const rotationInterval = setInterval(() => {
                rotationCount++;
                const angle = rotationCount * 360; // Rotar 360¬∞ por cada iteraci√≥n
                diceFace.style.transform = `rotate(${angle}deg)`;
                if (rotationCount >= maxRotations) {
                    clearInterval(rotationInterval);
                    diceFace.style.transform = 'rotate(0deg)'; // Volver a la posici√≥n inicial
                    coinSound.play();
                    Toastify({
                        text: `Sacaste un ${roll}`,
                        duration: 2000,
                        style: { background: '#2ecc71', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                    }).showToast();
                    setTimeout(() => {
                        lastSteps = roll;
                        moveCar(currentPlayer, roll);
                        isShaking = false;
                    }, 500);
                }
            }, 200); // Cada 200ms un nuevo giro completo
        }
        // Sacudida en m√≥vil
        function setupShakeDetection() {
            if (window.DeviceMotionEvent) {
                let lastX, lastY, lastZ;
                let lastTime = 0;
                const shakeThreshold = 15;
                window.addEventListener('devicemotion', (event) => {
                    if (isShaking) return;
                    const { x, y, z } = event.accelerationIncludingGravity;
                    const currentTime = new Date().getTime();
                    if (lastX !== undefined && currentTime - lastTime > 100) {
                        const diffX = Math.abs(x - lastX);
                        const diffY = Math.abs(y - lastY);
                        const diffZ = Math.abs(z - lastZ);
                        if (diffX > shakeThreshold || diffY > shakeThreshold || diffZ > shakeThreshold) {
                            rollDice();
                            lastTime = currentTime;
                        }
                    }
                    lastX = x;
                    lastY = y;
                    lastZ = z;
                });
                if (window.innerWidth <= 600) {
                    Toastify({
                        text: '¬°Sacude el tel√©fono para tirar el dado!',
                        duration: 3000,
                        style: { background: '#4caf50', fontSize: '12px' }
                    }).showToast();
                }
            }
        }

        // Mover auto
        function moveCar(player, steps) {
            let currentPos = positions[player - 1];
            totalSteps[player - 1] += steps;

            function moveStep(step) {
                if (step <= 0) {
                    positions[player - 1] = currentPos;
                    const cell = cells.find(c => c.dataset.index == currentPos);
                    checkCell(player, currentPos, cell);
                    return;
                }
                currentPos = (currentPos + 1) % totalCells;
                if (currentPos === 0) {
                    laps[player - 1]++;
                    currentLapDisplay.textContent = laps[player - 1];
                }
                const { x, y } = getCellCoordinates(currentPos);
                const car = document.querySelector(`.car${player}`);
                const rotation = getRotation(currentPos);
                car.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
                const { x: miniX, y: miniY } = getMiniMapCoordinates(currentPos);
                const miniCar = document.querySelectorAll('.mini-car')[player - 1];
                miniCar.style.transform = `translate(${miniX}px, ${miniY}px)`;
                advanceSound.play();
                updateProgress(player);
                setTimeout(() => moveStep(step - 1), 1000);
            }
            moveStep(steps);
        }

        // Mover a posici√≥n espec√≠fica
        function moveCarToPosition(player, newPos, additionalSteps) {
            const oldPos = positions[player - 1];
            positions[player - 1] = newPos;
            totalSteps[player - 1] += additionalSteps;
            if (newPos === 0 && additionalSteps > 0) {
                laps[player - 1]++;
                currentLapDisplay.textContent = laps[player - 1];
            }
            const { x, y } = getCellCoordinates(newPos);
            const car = document.querySelector(`.car${player}`);
            const rotation = getRotation(newPos);
            car.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
            const { x: miniX, y: miniY } = getMiniMapCoordinates(newPos);
            const miniCar = document.querySelectorAll('.mini-car')[player - 1];
            miniCar.style.transform = `translate(${miniX}px, ${miniY}px)`;
            if (additionalSteps < 0) reverseSound.play();
            else moveSound.play();
            updateProgress(player);
        }

        // Actualizar barra de progreso
        function updateProgress(player) {
            const progressPercent = Math.min((totalSteps[player - 1] / (totalCells * totalLaps)) * 100, 100);
            progress.style.width = `${progressPercent}%`;
        }

        // Actualizar efectos de estado
        function updateStatusEffects(player) {
            const statusElement = player === 1 ? status1 : status2;
            statusElement.innerHTML = '';
            if (skipTurns[player - 1] > 0) {
                const skip = document.createElement('span');
                skip.classList.add('status-effect', 'negative');
                skip.innerHTML = `<i class="fas fa-pause"></i> Pierde ${skipTurns[player - 1]} turno(s)`;
                statusElement.appendChild(skip);
            }
            if (shieldActive[player - 1]) {
                const shield = document.createElement('span');
                shield.classList.add('status-effect', 'positive');
                shield.innerHTML = `<i class="fas fa-shield-alt"></i> Escudo`;
                statusElement.appendChild(shield);
            }
            if (boostActive[player - 1]) {
                const boost = document.createElement('span');
                boost.classList.add('status-effect', 'positive');
                boost.innerHTML = `<i class="fas fa-bolt"></i> Nitro`;
                statusElement.appendChild(boost);
            }
            if (carCondition[player - 1] < 80) {
                const condition = document.createElement('span');
                condition.classList.add('status-effect', 'negative');
                condition.innerHTML = `<i class="fas fa-car-crash"></i> Da√±o ${carCondition[player - 1]}%`;
                statusElement.appendChild(condition);
            }
        }

        // Usar power-up
        powerUpsContainer.addEventListener('click', async (e) => {
            const powerUp = e.target.closest('.power-up');
            if (!powerUp || powerUp.classList.contains('disabled') || gameEnded) return;
            const type = powerUp.dataset.type;
            const player = currentPlayer - 1;
            if (!itemInventory[player].includes(type)) return;

            itemInventory[player] = itemInventory[player].filter(item => item !== type);
            powerUp.classList.add('disabled');

            if (type === 'shield') {
                shieldActive[player] = true;
                shieldSound.play();
                Toastify({
                    text: `${playerNames[player]} activ√≥ un escudo.`,
                    duration: 3000,
                    style: { background: '#4caf50', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player + 1);
            } else if (type === 'boost') {
                boostActive[player] = true;
                boostSound.play();
                Toastify({
                    text: `${playerNames[player]} activ√≥ nitro.`,
                    duration: 3000,
                    style: { background: '#4caf50', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player + 1);
            } else if (type === 'repair') {
                carCondition[player] = 100;
                repairSound.play();
                Toastify({
                    text: `${playerNames[player]} repar√≥ el auto.`,
                    duration: 3000,
                    style: { background: '#4caf50', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player + 1);
            } else if (type === 'trap') {
                const trapPos = positions[player];
                traps.push({ pos: trapPos, owner: player + 1 });
                explosionSound.play();
                Toastify({
                    text: `${playerNames[player]} coloc√≥ una trampa en la casilla ${trapPos}.`,
                    duration: 3000,
                    style: { background: '#ff9800', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
            } else if (type === 'teleport') {
                const newPos = Math.floor(Math.random() * totalCells);
                moveCarToPosition(player + 1, newPos, newPos - positions[player]);
                Toastify({
                    text: `${playerNames[player]} se teletransport√≥ a la casilla ${newPos}.`,
                    duration: 3000,
                    style: { background: '#4caf50', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
            }
        });

        // Verificar casilla
        async function checkCell(player, pos, cell) {
            let message = '';
            let bgColor = '#2196f3';
            let points = 0;
            let moveToPos = null;
            let moveSteps = 0;
            let damage = 0;

            // Verificar trampa
            const trap = traps.find(t => t.pos === pos && t.owner !== player);
            if (trap && !shieldActive[player - 1]) {
                damage = 20;
                carCondition[player - 1] -= damage;
                traps = traps.filter(t => t.pos !== pos);
                explosionSound.play();
                message = '¬°Ca√≠ste en una trampa! Pierdes 20% de condici√≥n.';
                bgColor = '#ff9800';
                Toastify({
                    text: message,
                    duration: 3000,
                    style: { background: bgColor, fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player);
                if (carCondition[player - 1] <= 0) {
                    gameEnded = true;
                    Swal.fire({
                        title: `¬°${playerNames[player - 1]} se qued√≥ sin auto!`,
                        text: `${playerNames[player % 2]} gana.`,
                        icon: 'error',
                        confirmButtonText: 'Reiniciar'
                    }).then(() => {
                        localStorage.removeItem('player1Score');
                        localStorage.removeItem('player2Score');
                        window.location.reload();
                    });
                    return;
                }
                switchPlayer();
                return;
            } else if (trap && shieldActive[player - 1]) {
                shieldActive[player - 1] = false;
                traps = traps.filter(t => t.pos !== pos);
                shieldSound.play();
                message = '¬°El escudo bloque√≥ una trampa!';
                bgColor = '#4caf50';
                Toastify({
                    text: message,
                    duration: 3000,
                    style: { background: bgColor, fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player);
            }

            // Efectos clim√°ticos
            if (currentWeather === 'rain' && Math.random() < 0.3 && !shieldActive[player - 1]) {
                damage = 10;
                carCondition[player - 1] -= damage;
                message = '¬°Lluvia resbaladiza! Pierdes 10% de condici√≥n.';
                bgColor = '#ff9800';
                Toastify({
                    text: message,
                    duration: 3000,
                    style: { background: bgColor, fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player);
            } else if (currentWeather === 'snow' && Math.random() < 0.4 && !shieldActive[player - 1]) {
                skipTurns[player - 1] = 1;
                message = '¬°Nieve pesada! Pierdes un turno.';
                bgColor = '#ff9800';
                Toastify({
                    text: message,
                    duration: 3000,
                    style: { background: bgColor, fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player);
            }

            // Casillas
            if (cell.classList.contains('mud')) {
                if (!shieldActive[player - 1]) {
                    skipTurns[player - 1] = 1;
                    damage = 10;
                    carCondition[player - 1] -= damage;
                    message = '¬°Charco de lodo! Pierdes un turno y 10% de condici√≥n.';
                    bgColor = '#ff9800';
                    penaltySound.play();
                } else {
                    shieldActive[player - 1] = false;
                    message = '¬°El escudo bloque√≥ el lodo!';
                    bgColor = '#4caf50';
                    shieldSound.play();
                }
            } else if (cell.classList.contains('water')) {
                if (!shieldActive[player - 1]) {
                    moveToPos = Math.max(0, pos - 2);
                    moveSteps = -2;
                    damage = 5;
                    carCondition[player - 1] -= damage;
                    message = '¬°Charco de agua! Retrocedes 2 casillas y pierdes 5% de condici√≥n.';
                    bgColor = '#ff9800';
                    moveCarToPosition(player, moveToPos, moveSteps);
                } puncture(player, 5);
            } else if (cell.classList.contains('oil')) {
                if (!shieldActive[player - 1]) {
                    moveToPos = Math.max(0, pos - 3);
                    moveSteps = -3;
                    damage = 10;
                    carCondition[player - 1] -= damage;
                    message = '¬°Charco de aceite! Retrocedes 3 casillas y pierdes 10% de condici√≥n.';
                    bgColor = '#ff9800';
                    moveCarToPosition(player, moveToPos, moveSteps);
                } else {
                    shieldActive[player - 1] = false;
                    message = '¬°El escudo bloque√≥ el aceite!';
                    bgColor = '#4caf50';
                    shieldSound.play();
                }
            } else if (cell.classList.contains('fire')) {
                if (!shieldActive[player - 1]) {
                    skipTurns[player - 1] = 2;
                    damage = 20;
                    carCondition[player - 1] -= damage;
                    message = '¬°Incendio! Pierdes 2 turnos y 20% de condici√≥n.';
                    bgColor = '#f44336';
                    penaltySound.play();
                } else {
                    shieldActive[player - 1] = false;
                    message = '¬°El escudo bloque√≥ el incendio!';
                    bgColor = '#4caf50';
                    shieldSound.play();
                }
            } else if (cell.classList.contains('police')) {
                if (!shieldActive[player - 1]) {
                    skipTurns[player - 1] = 2;
                    message = '¬°Infracci√≥n! Pierdes 2 turnos.';
                    bgColor = '#f44336';
                    penaltySound.play();
                } else {
                    shieldActive[player - 1] = false;
                    message = '¬°El escudo evit√≥ la infracci√≥n!';
                    bgColor = '#4caf50';
                    shieldSound.play();
                }
            } else if (cell.classList.contains('animal_bad')) {
                if (!shieldActive[player - 1]) {
                    moveToPos = Math.max(0, pos - 5);
                    moveSteps = -5;
                    damage = 15;
                    carCondition[player - 1] -= damage;
                    message = '¬°Mono travieso! Retrocedes 5 casillas y pierdes 15% de condici√≥n.';
                    bgColor = '#ff9800';
                    moveCarToPosition(player, moveToPos, moveSteps);
                } else {
                    shieldActive[player - 1] = false;
                    message = '¬°El escudo bloque√≥ al mono!';
                    bgColor = '#4caf50';
                    shieldSound.play();
                }
            } else if (cell.classList.contains('animal_good')) {
                moveToPos = (pos + 5) % totalCells;
                moveSteps = 5;
                points += 50;
                message = '¬°Conejo veloz! Avanzas 5 casillas y ganas 50 puntos.';
                bgColor = '#4caf50';
                moveCarToPosition(player, moveToPos, moveSteps);
            } else if (cell.classList.contains('ramp')) {
                moveToPos = (pos + 7) % totalCells;
                moveSteps = 7;
                points += 30;
                message = '¬°Rampa! Saltas 7 casillas y ganas 30 puntos.';
                bgColor = '#4caf50';
                moveCarToPosition(player, moveToPos, moveSteps);
            } else if (cell.classList.contains('turbo')) {
                moveToPos = (pos + 10) % totalCells;
                moveSteps = 10;
                points += 50;
                message = '¬°Turbo! Avanzas 10 casillas y ganas 50 puntos.';
                bgColor = '#4caf50';
                moveCarToPosition(player, moveToPos, moveSteps);
            } else if (cell.classList.contains('detour')) {
                if (!shieldActive[player - 1]) {
                    moveToPos = Math.max(0, pos - 5);
                    moveSteps = -5;
                    message = '¬°Desv√≠o! Retrocedes 5 casillas.';
                    bgColor = '#ff9800';
                    moveCarToPosition(player, moveToPos, moveSteps);
                } else {
                    shieldActive[player - 1] = false;
                    message = '¬°El escudo evit√≥ el desv√≠o!';
                    bgColor = '#4caf50';
                    shieldSound.play();
                }
            } else if (cell.classList.contains('animal_rescue')) {
                moveToPos = (pos + 8) % totalCells;
                moveSteps = 8;
                points += 40;
                message = '¬°Perro rescatador! Avanzas 8 casillas y ganas 40 puntos.';
                bgColor = '#4caf50';
                moveCarToPosition(player, moveToPos, moveSteps);
            } else if (cell.classList.contains('tire-change')) {
                if (!shieldActive[player - 1]) {
                    moveToPos = Math.max(0, pos - 3);
                    moveSteps = -3;
                    damage = 10;
                    carCondition[player - 1] -= damage;
                    message = '¬°Recambio de cubiertas! Retrocedes 3 casillas y pierdes 10% de condici√≥n.';
                    bgColor = '#ff9800';
                    moveCarToPosition(player, moveToPos, moveSteps);
                } else {
                    shieldActive[player - 1] = false;
                    message = '¬°El escudo evit√≥ el recambio!';
                    bgColor = '#4caf50';
                    shieldSound.play();
                }
            } else if (cell.classList.contains('history-quiz')) {
                const quiz = paraguayQuestions[Math.floor(Math.random() * paraguayQuestions.length)];
                const { value: answer } = await Swal.fire({
                    title: 'Pregunta sobre la historia de Paraguay',
                    text: quiz.question,
                    input: 'radio',
                    inputOptions: quiz.options.reduce((obj, opt) => ({ ...obj, [opt]: opt }), {}),
                    inputValidator: (value) => !value && '¬°Debes seleccionar una opci√≥n!'
                });
                if (answer) {
                    if (answer === quiz.correct) {
                        moveToPos = (pos + 5) % totalCells;
                        moveSteps = 5;
                        points += 50;
                        message = '¬°Respuesta correcta! Avanzas 5 casillas y ganas 50 puntos.';
                        bgColor = '#4caf50';
                        moveCarToPosition(player, moveToPos, moveSteps);
                    } else {
                        moveToPos = Math.max(0, pos - 3);
                        moveSteps = -3;
                        message = '¬°Respuesta incorrecta! Retrocedes 3 casillas.';
                        bgColor = '#ff9800';
                        moveCarToPosition(player, moveToPos, moveSteps);
                    }
                } else {
                    message = '¬°No respondiste! Pierdes el turno.';
                    bgColor = '#ff9800';
                    penaltySound.play();
                }
            } else if (cell.classList.contains('music-quiz')) {
                const quiz = musicQuestions[Math.floor(Math.random() * musicQuestions.length)];
                const { value: answer } = await Swal.fire({
                    title: 'Pregunta sobre m√∫sica',
                    text: quiz.question,
                    input: 'radio',
                    inputOptions: quiz.options.reduce((obj, opt) => ({ ...obj, [opt]: opt }), {}),
                    inputValidator: (value) => !value && '¬°Debes seleccionar una opci√≥n!'
                });
                if (answer) {
                    if (answer === quiz.correct) {
                        moveToPos = (pos + 5) % totalCells;
                        moveSteps = 5;
                        points += 50;
                        message = '¬°Respuesta correcta! Avanzas 5 casillas y ganas 50 puntos.';
                        bgColor = '#4caf50';
                        moveCarToPosition(player, moveToPos, moveSteps);
                    } else {
                        moveToPos = Math.max(0, pos - 3);
                        moveSteps = -3;
                        message = '¬°Respuesta incorrecta! Retrocedes 3 casillas.';
                        bgColor = '#ff9800';
                        moveCarToPosition(player, moveToPos, moveSteps);
                    }
                } else {
                    message = '¬°No respondiste! Pierdes el turno.';
                    bgColor = '#ff9800';
                    penaltySound.play();
                }
            } else if (cell.classList.contains('shop')) {
                const items = ['shield', 'boost', 'repair', 'trap', 'teleport'];
                const item = items[Math.floor(Math.random() * items.length)];
                itemInventory[player - 1].push(item);
                message = `¬°Tienda! Obtuviste un ${item}.`;
                bgColor = '#4caf50';
                coinSound.play();
                document.querySelector(`.power-up[data-type="${item}"]`).classList.remove('disabled');
            } else if (cell.classList.contains('bonus')) {
                points += 100;
                message = '¬°Bono! Ganas 100 puntos.';
                bgColor = '#4caf50';
                coinSound.play();
            } else if (cell.classList.contains('event')) {
                const events = [
                    { effect: 'points', value: 50, message: '¬°Evento especial! Ganas 50 puntos.' },
                    { effect: 'move', value: 3, message: '¬°Evento especial! Avanzas 3 casillas.' },
                    { effect: 'damage', value: -10, message: '¬°Evento especial! Pierdes 10% de condici√≥n.' }
                ];
                const event = events[Math.floor(Math.random() * events.length)];
                if (event.effect === 'points') {
                    points += event.value;
                } else if (event.effect === 'move') {
                    moveToPos = (pos + event.value) % totalCells;
                    moveSteps = event.value;
                    moveCarToPosition(player, moveToPos, moveSteps);
                } else {
                    damage = -event.value;
                    carCondition[player - 1] -= damage;
                }
                message = event.message;
                bgColor = event.effect === 'damage' ? '#ff9800' : '#4caf50';
            } else {
                message = `${playerNames[player - 1]} avanz√≥ ${lastSteps} casillas.`;
                bgColor = '#2196f3';
            }

            // Actualizar puntuaci√≥n y condici√≥n
            scores[player - 1] += points;
            score1.textContent = scores[0];
            score2.textContent = scores[1];
            localStorage.setItem('player1Score', scores[0]);
            localStorage.setItem('player2Score', scores[1]);
            updateStatusEffects(player);

            // Verificar victoria
            if (laps[player - 1] > totalLaps) {
                gameEnded = true;
                winSound.play();
                const jsConfetti = new JSConfetti();
                jsConfetti.addConfetti({ emojis: ['üåü', 'üéâ'], confettiNumber: 100 });
                setTimeout(() => jsConfetti.clearCanvas(), 2000);
                localStorage.setItem('raceRecord', JSON.stringify({
                    name: playerNames[player - 1],
                    score: scores[player - 1],
                    date: new Date().toLocaleString()
                }));
                Swal.fire({
                    title: `¬°${playerNames[player - 1]} gana!`,
                    text: `Completaste ${totalLaps} vueltas. Puntuaci√≥n: ${scores[player - 1]} puntos.`,
                    icon: 'success',
                    confirmButtonText: 'Reiniciar'
                }).then(() => {
                    localStorage.removeItem('player1Score');
                    localStorage.removeItem('player2Score');
                    window.location.reload();
                });
                return;
            }

            // Mostrar notificaci√≥n
            Toastify({
                text: `${playerNames[player - 1]}: ${message}`,
                duration: 3000,
                style: { background: bgColor, fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
            }).showToast();

            // Cambiar turno
            if (!moveToPos) switchPlayer();
        }

        // Cambiar turno
        function switchPlayer() {
            boostActive[currentPlayer - 1] = false;
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            turnDisplay.textContent = playerNames[currentPlayer - 1];
            updateStatusEffects(currentPlayer);
        }

        // Botones de control
        helpBtn.addEventListener('click', showTutorial);

        inventoryBtn.addEventListener('click', () => {
            const player = currentPlayer - 1;
            const items = itemInventory[player].length ? itemInventory[player].join(', ') : 'Vac√≠o';
            Swal.fire({
                title: `Inventario de ${playerNames[player]}`,
                text: `Objetos: ${items}`,
                icon: 'info'
            });
        });

        boostBtn.addEventListener('click', () => {
            if (gameEnded || boostActive[currentPlayer - 1]) return;
            if (itemInventory[currentPlayer - 1].includes('boost')) {
                itemInventory[currentPlayer - 1] = itemInventory[currentPlayer - 1].filter(item => item !== 'boost');
                boostActive[currentPlayer - 1] = true;
                boostSound.play();
                Toastify({
                    text: `${playerNames[currentPlayer - 1]} activ√≥ nitro.`,
                    duration: 3000,
                    style: { background: '#4caf50', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(currentPlayer);
            } else {
                Toastify({
                    text: 'No tienes nitro en el inventario.',
                    duration: 3000,
                    style: { background: '#ff9800', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
            }
        });

        // Inicializar
        async function init() {
            showTutorial();
            await getPlayerDetails();
            createTrack();
            score1.textContent = scores[0];
            score2.textContent = scores[1];
            totalLapsDisplay.textContent = totalLaps;
            dice.addEventListener('click', rollDice);
            setupShakeDetection();
            updateProgress(1);
            updateProgress(2);
            updateStatusEffects(1);
            updateStatusEffects(2);

            // Deshabilitar power-ups no disponibles inicialmente
            document.querySelectorAll('.power-up').forEach(powerUp => {
                const type = powerUp.dataset.type;
                if (!itemInventory[currentPlayer - 1].includes(type)) {
                    powerUp.classList.add('disabled');
                }
            });

            // Mostrar mensaje de bienvenida
            Toastify({
                text: `¬°Bienvenidos a Super Carreras Paraguay! ${playerNames[0]} comienza.`,
                duration: 4000,
                style: { background: '#2196f3', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
            }).showToast();
        }

        // Funci√≥n para manejar da√±os adicionales (como pinchazos)
        function puncture(player, damage) {
            if (!shieldActive[player - 1]) {
                carCondition[player - 1] -= damage;
                penaltySound.play();
                Toastify({
                    text: `¬°Pinchazo! ${playerNames[player - 1]} pierde ${damage}% de condici√≥n.`,
                    duration: 3000,
                    style: { background: '#ff9800', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player);
                if (carCondition[player - 1] <= 0) {
                    gameEnded = true;
                    Swal.fire({
                        title: `¬°${playerNames[player - 1]} se qued√≥ sin auto!`,
                        text: `${playerNames[player % 2]} gana.`,
                        icon: 'error',
                        confirmButtonText: 'Reiniciar'
                    }).then(() => {
                        localStorage.removeItem('player1Score');
                        localStorage.removeItem('player2Score');
                        window.location.reload();
                    });
                }
            } else {
                shieldActive[player - 1] = false;
                shieldSound.play();
                Toastify({
                    text: '¬°El escudo bloque√≥ el pinchazo!',
                    duration: 3000,
                    style: { background: '#4caf50', fontSize: window.innerWidth <= 600 ? '9px' : '14px' }
                }).showToast();
                updateStatusEffects(player);
            }
        }

        // Guardar r√©cord si es necesario
        function saveRecord(player) {
            const currentRecord = JSON.parse(localStorage.getItem('raceRecord'));
            if (!currentRecord || scores[player - 1] > currentRecord.score) {
                localStorage.setItem('raceRecord', JSON.stringify({
                    name: playerNames[player - 1],
                    score: scores[player - 1],
                    date: new Date().toLocaleString()
                }));
            }
        }

        // Manejo de eventos adicionales
        window.addEventListener('resize', () => {
            // Actualizar posiciones de los autos al cambiar el tama√±o de la ventana
            moveCarToPosition(1, positions[0], 0);
            moveCarToPosition(2, positions[1], 0);
        });

        // Iniciar el juego
        init();
    </script>